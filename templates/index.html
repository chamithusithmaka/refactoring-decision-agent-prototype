<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDP Agent — Refactoring Decision &amp; Planning</title>
    <meta name="description" content="Upload a quality report JSON and generate a structured refactoring plan.">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}?v=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Animated background particles -->
    <div class="bg-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
                    <rect width="36" height="36" rx="8" fill="url(#grad)"/>
                    <path d="M10 18L16 12L22 18L16 24L10 18Z" fill="white" opacity="0.9"/>
                    <path d="M16 12L22 18L28 12L22 6L16 12Z" fill="white" opacity="0.6"/>
                    <defs><linearGradient id="grad" x1="0" y1="0" x2="36" y2="36"><stop stop-color="#6366f1"/><stop offset="1" stop-color="#8b5cf6"/></linearGradient></defs>
                </svg>
                <div>
                    <h1>RDP Agent</h1>
                    <p class="subtitle">Refactoring Decision &amp; Planning Agent</p>
                </div>
            </div>
        </header>

        <!-- Upload Section -->
        <section class="card upload-card" id="upload-section">
            <h2>Upload Quality Report</h2>
            <p class="card-desc">Select a JSON quality report from the Code Understanding Agent to generate a refactoring plan.</p>

            <form id="upload-form" enctype="multipart/form-data">
                <div class="drop-zone" id="drop-zone">
                    <svg class="drop-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                    </svg>
                    <p class="drop-text">Drag &amp; drop a <strong>.json</strong> file here</p>
                    <p class="drop-or">or</p>
                    <label class="btn btn-secondary" for="file-input">Browse Files</label>
                    <input type="file" id="file-input" name="file" accept=".json" hidden>
                    <p class="file-name" id="file-name"></p>
                </div>

                <button type="submit" class="btn btn-primary" id="generate-btn" disabled>
                    <span class="btn-text">Generate Refactoring Plan</span>
                    <span class="btn-loader" hidden>
                        <svg class="spinner" width="20" height="20" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg>
                        Processing…
                    </span>
                </button>
            </form>
        </section>

        <!-- Error Message -->
        <div class="alert alert-error" id="error-alert" hidden>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>
            <span id="error-message"></span>
        </div>

        <!-- Results Section -->
        <section class="card result-card" id="result-section" hidden>
            <div class="result-header">
                <h2>Refactoring Plan</h2>
                <div class="result-actions">
                    <button class="btn btn-icon" id="copy-btn" title="Copy JSON">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                    </button>
                    <button class="btn btn-icon" id="download-btn" title="Download JSON">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                    </button>
                </div>
            </div>

            <!-- Plan Summary -->
            <div class="plan-summary" id="plan-summary"></div>

            <!-- Steps -->
            <div class="steps-container" id="steps-container"></div>

            <!-- Raw JSON Toggle -->
            <details class="json-details">
                <summary class="btn btn-ghost">View Raw JSON</summary>
                <pre class="json-output" id="json-output"></pre>
            </details>
        </section>
    </div>

    <script>

        // ---- DOM Elements ----
        const dropZone    = document.getElementById('drop-zone');
        const fileInput   = document.getElementById('file-input');
        const fileNameEl  = document.getElementById('file-name');
        const generateBtn = document.getElementById('generate-btn');
        const form        = document.getElementById('upload-form');
        const errorAlert  = document.getElementById('error-alert');
        const errorMsg    = document.getElementById('error-message');
        const resultSec   = document.getElementById('result-section');
        const planSummary = document.getElementById('plan-summary');
        const stepsContainer = document.getElementById('steps-container');
        const jsonOutput  = document.getElementById('json-output');
        const copyBtn     = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn');

        // Ensure error alert is hidden on page load
        document.addEventListener('DOMContentLoaded', () => {
            errorAlert.hidden = true;
        });

        let currentPlan = null;

        // ---- Drag & Drop ----
        ['dragenter', 'dragover'].forEach(evt => {
            dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        });
        ['dragleave', 'drop'].forEach(evt => {
            dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        });
        dropZone.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            if (files.length > 0) { fileInput.files = files; handleFileSelect(); }
        });

        // ---- File Selection ----
        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                fileNameEl.textContent = file.name;
                fileNameEl.style.display = 'block';
                generateBtn.disabled = false;
                hideError();
            }
        }

        // ---- Form Submit ----
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            resultSec.hidden = true;

            const file = fileInput.files[0];
            if (!file) return;

            // Show loader
            const btnText   = generateBtn.querySelector('.btn-text');
            const btnLoader = generateBtn.querySelector('.btn-loader');
            btnText.hidden = true;
            btnLoader.hidden = false;
            generateBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);

                const resp = await fetch('/generate', { method: 'POST', body: formData });
                const data = await resp.json();

                if (!resp.ok || data.error) {
                    showError(data.error || 'Unknown error occurred.');
                    return;
                }

                currentPlan = data.plan;
                renderPlan(currentPlan);
                resultSec.hidden = false;
                resultSec.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (err) {
                showError('Network error: ' + err.message);
            } finally {
                btnText.hidden = false;
                btnLoader.hidden = true;
                generateBtn.disabled = false;
            }
        });

        // ---- Render Plan ----
        function renderPlan(plan) {
            // Summary card
            planSummary.innerHTML = `
                <div class="summary-grid">
                    <div class="stat">
                        <span class="stat-value">${plan.steps.length}</span>
                        <span class="stat-label">Steps</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">${plan.target}</span>
                        <span class="stat-label">Target File</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">${plan.plan_id}</span>
                        <span class="stat-label">Plan ID</span>
                    </div>
                </div>
                <p class="summary-text">${plan.summary}</p>
            `;

            // Steps
            stepsContainer.innerHTML = '';
            plan.steps.forEach((step, i) => {
                const el = document.createElement('div');
                el.className = 'step-card';
                el.style.animationDelay = `${i * 0.08}s`;
                el.innerHTML = `
                    <div class="step-header">
                        <span class="step-badge">${step.step_id}</span>
                        <h3 class="step-title">${step.refactoring}</h3>
                        <span class="step-smell">${step.smell_id}</span>
                    </div>
                    <div class="step-target">
                        <strong>Target:</strong> ${step.target.class || '—'}${step.target.method ? '.' + step.target.method : ''}
                    </div>
                    <p class="step-explanation">${step.explanation}</p>
                    ${Object.keys(step.parameters).length > 0 ? `
                        <details class="step-params">
                            <summary>Parameters</summary>
                            <pre>${JSON.stringify(step.parameters, null, 2)}</pre>
                        </details>
                    ` : ''}
                `;
                stepsContainer.appendChild(el);
            });

            // Raw JSON
            jsonOutput.textContent = JSON.stringify(plan, null, 2);
        }

        // ---- Copy / Download ----
        copyBtn.addEventListener('click', () => {
            if (!currentPlan) return;
            navigator.clipboard.writeText(JSON.stringify(currentPlan, null, 2));
            copyBtn.classList.add('copied');
            setTimeout(() => copyBtn.classList.remove('copied'), 1500);
        });

        downloadBtn.addEventListener('click', () => {
            if (!currentPlan) return;
            const blob = new Blob([JSON.stringify(currentPlan, null, 2)], { type: 'application/json' });
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');
            a.href = url;
            a.download = `${currentPlan.plan_id || 'refactoring_plan'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // ---- Error helpers ----
        function showError(msg) {
            errorMsg.textContent = msg;
            errorAlert.hidden = false;
        }
        function hideError() {
            errorAlert.hidden = true;
        }
    </script>
</body>
</html>
